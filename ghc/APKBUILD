# Contributor: Mitch Tishmack <mitch.tishmack@gmail.com>
# Maintainer: Mitch Tishmack <mitch.tishmack@gmail.com>
pkgname=ghc
pkgdesc="The Glasgow haskell compiler"
pkgver=7.10.2
pkgrel=1
url="http://haskell.org"
arch="x86_64"
# Note ghc's license is basically bsd3. If you'd like to know more visit:
# https://www.haskell.org/ghc/license
# https://ghc.haskell.org/trac/ghc/wiki/Licensing
license="custom"
depends="bash gcc perl gmp-dev libffi musl-dev"
makedepends="bzip2 xz gzip libtool autoconf automake libxslt libffi-dev linux-headers perl ncurses-dev zlib-dev $depends_dev"
install=""
subpackages="$pkgname-doc"
_builddir="$srcdir/$pkgname-$pkgver"
source="
	https://www.haskell.org/ghc/dist/$pkgver/ghc-$pkgver-src.tar.bz2
	"
# bootstrap compiler is just a giant tarball, so no need to patch
# anything
if [ -z "$BOOTSTRAP" ]; then
	if [ -z "$VIABOOTSTRAP" ]; then
		makedepends="ghc cabal-install $makedepends"
	else
		makedepends="ghc-bootstrap $makedepends"
	fi
	prepare() {
		local i
		cd "$_builddir"
		for i in $source; do
			case $i in
			*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
			esac
		done
	}
else
	# $BOOTSTRAP if set needs to be the tar.gz cross compiler generated off of
	# a glibc system.
	pkgname="$pkgname-bootstrap"
	pkgdesc="$pkgdesc (bootstrapped)"
	_builddir="$srcdir"
	subpackages=""
	source="$BOOTSTRAP"
fi

basic_check() {
	# Just make sure we can compile a basic file
	cd "$_builddir"
	echo 'main = putStrLn "ok"'> test.hs || return 1
	ghc --make test.hs || return 1
	./test || return 1
	rm test test.o test.hi test.hs || return 1
}

# Bit of repetition here with cabal-install, but its OK
bootstrap_cabal() {
	cd "$_builddir"
	cabal_version=1.22.6.0
	export PATH="${PATH}:$_builddir/cabal-install-${cabal_version}/.cabal-sandbox/bin"
	curl -L "https://www.haskell.org/cabal/release/cabal-install-${cabal_version}/cabal-install-${cabal_version}.tar.gz" | gunzip -c - | tar xf - || return 1
	cd "cabal-install-${cabal_version}" || return 1
	export NO_DOCUMENTATION=yes
	export DEFAULT_CONFIGURE_OPTS="--shared"
	./bootstrap.sh --sandbox || return 1
	rm -fr "cabal-install-${cabal_version}" || return 1
}

generate_build_mk() {
	cat > mk/build.mk << "FIN"
SRC_HC_OPTS          += -optl-pthread
SRC_HC_OPTS          += -H64m -O2 -fPIC
SRC_CC_OPTS          += -O2 -fPIC
GhcLibHcOpts         += -O2 -fPIC
GhcHcOpts            += -Rghc-timing -fPIC
SplitObjs             = YES
STRIP                 = :
GhcRtsCcOpts         += -O2 -fPIC
GhcRtsWays           += p
V                     = 1
BeConservative        = YES
FIN
}

sandbox_prerequisites() {
	cd "$_builddir"
	export PATH=$PATH:$(pwd)/.cabal-sandbox/bin
	OHOME="${HOME}"
	export HOME="$_builddir"
	cabal update
	cabal sandbox init
	cabal install happy alex
	export HOME="${OHOME}"
}

build_normal() {
	cd "$_builddir"
	basic_check
	type -p cabal
	if [ $? = 1 ]; then
		bootstrap_cabal
	fi
	build_common
}

build_common() {
	sandbox_prerequisites
	generate_build_mk
	mv libraries/integer-gmp integer-gmp.old || return 1
	ln -s integer-gmp2 libraries/integer-gmp || return 1
	./configure \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--localstatedir=/var || return 1
	make || return 1
}

build() {
	if [ -z "$BOOTSTRAP" ]; then
		build_normal
	fi
}

package_normal() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1
	settings=$(find "$pkgdir" -name settings -type f)
	# needed until ghc can emit pie assembly
	# ref https://ghc.haskell.org/trac/ghc/ticket/9007
	perl -pi -e 's/.*C compiler link flags.*/ \(\"C compiler link flags\"\, \"-nopie\"\)\,/' "$settings" || return 1
	install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE" || return 1
}

package() {
	if [ -z "$BOOTSTRAP" ]; then
		package_normal
	else
		cd "$_builddir"
		mkdir -p "$pkgdir" || return 1
		mv usr "$pkgdir" || return 1
	fi
}
md5sums="d4e1be9ab132f4afe9ac517c15d36fde  ghc-7.10.2-src.tar.bz2"
sha256sums="8d6b58ca000479432411cf0adcc443953ef089e04bcbba8d62d1d283446b2271  ghc-7.10.2-src.tar.bz2"
sha512sums="ba130597d68013590f1fdf1ee52efed081d6d064826ec1b5e037cad1ad29720fa58edf1728c7342cd285f8aeb9d74143aa51ec88e5a3f4af480a9e77e23d45d6  ghc-7.10.2-src.tar.bz2"
