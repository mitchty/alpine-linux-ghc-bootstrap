#-*-mode: Shell-script; coding: utf-8;-*-
# Contributor: Mitch Tishmack <mitch.tishmack@gmail.com>
# Maintainer: Mitch Tishmack <mitch.tishmack@gmail.com>
#
# Mostly here for porting, beyond that the native ghc
# should be preferred.
#
# Must also keep all the patch files in sync with
# normal ghc package.
pkgname=ghc-bootstrap
pkgdesc="The Glasgow haskell compiler (bootstrapped)"
apkgver=7.10.3b
pkgrel=0
pkgver=$(echo ${apkgver} | tr -d '[a-z]')
url="http://haskell.org"
subpackages=""
arch="x86_64"
source="https://s3-us-west-2.amazonaws.com/alpine-ghc/next/7.10/ghc-7.10.3-x86_64-unknown-linux-musl.tar.xz"
license="custom:bsd3"
depends="bash libffi musl zlib gcc binutils-gold ghc-llvm-3.5"
install=""
subpackages=""
makedepends="perl"

package() {
	cd "$srcdir"
	install -d "$pkgdir" || return 1
	mv usr "$pkgdir" || return 1
        settings=$(find "$pkgdir" -name settings -type f)
	perl -pi -e 's/.*C compiler link flags.*/ \(\"C compiler link flags\"\, \"-nopie\"\)\,/' "$settings" || return 1
}

# The bootstrap process uses docker to build ghc from a glibc based system
# then upload the bootstrap compiler to where that source url is.
#
# Ensure that docker is running prior to calling this.
snapshot () {
	make x86_64
	scp "ghc-$pkgver-$bs_arch-unknown-linux-musl.tar.xz" dev.alpinelinux.org:/archive/mod-sflow/ || return 1
}
md5sums="914f4029e72584e03c8bf3aac52b5039  ghc-7.10.3-x86_64-unknown-linux-musl.tar.xz"
sha256sums="b0873c2992af4ec755f3909e8d77181ad501022020a3a8df795cc08d44d31c73  ghc-7.10.3-x86_64-unknown-linux-musl.tar.xz"
sha512sums="c734f245c9f1dbea5aca9073b0fafb97676602d11dc3f1517d5bd8103959e8bb85a1597bc8e676310893c3db86bdf03016c3d2e72c7d1cd0638f0ff90a70e41c  ghc-7.10.3-x86_64-unknown-linux-musl.tar.xz"
